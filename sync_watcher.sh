#!/usr/bin/env bash
set -euo pipefail
trap 'logger -p error -t "SYNC_WATHER" "[$(date)] –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ $LINENO: –∫–æ–º–∞–Ω–¥–∞ \"$BASH_COMMAND\""' ERR

##
##  Project     : sync_1
##  Description : –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
##                –ß–∞—Å—Ç—å –ø–∞–∫–µ—Ç–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ sync_1.
##  File        : sync_1.sh
##  Author      : Ariv <ariv@meta.ua> | https://github.com/arivm7
##  Org         : RI-Network, Kiev, UK
##  License     : GPL v3
##    
##  Copyright (C) 2004-2025 Ariv <ariv@meta.ua> | https://github.com/arivm7 | RI-Network, Kiev, UK
##



VERSION="0.4.0-alfa (2025-12-26)"
COPYRIGHT="Copyright (C) 2004-2025 Ariv <ariv@meta.ua> | https://github.com/arivm7 | RI-Network, Kiev, UK"
LAST_CHANGES="\
v0.4.0 (2025-12-26): –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥ –∏–ª–∏ —á—Ä–µ–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä
v0.3.0 (2025-10-27): –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–º–∞–Ω–¥—ã –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä: –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–µ –ø–∞–ø–∫–∞, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ, –∞ –∫–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω–∏–ª–æ –æ—à–∏–±–∫—É –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–∏, —á—Ç–æ —Ä–∞–Ω–µ–µ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫—É –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–µ '–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'.
v0.2.2 (2025-08-25): –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
v0.2.1 (2025-08-05): –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å sync_1
v0.2.0 (2025-07-10): –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
"



APP_TITLE="–°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä"
APP_NAME=$(basename "$0")                                   # –ü–æ–ª–Ω–æ–µ –∏–º—è —Å–∫—Ä–∏–ø—Ç–∞, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
APP_PATH=$(cd "$(dirname "$0")" && pwd)                     # –ü—É—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
FILE_NAME="${APP_NAME%.*}"                                  # –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
# shellcheck disable=SC2034
SCRIPT_NAME=$(basename "${BASH_SOURCE[0]}")                 # –ü–æ–ª–Ω–æ–µ –∏–º—è [–≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ] —Å–∫—Ä–∏–ø—Ç–∞, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
# shellcheck disable=SC2034
SCRIPT_PATH=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)   # –ü—É—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è [–≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ] —Å–∫—Ä–∏–ø—Ç–∞

CONFIG_DIRNAME="sync"
CONFIG_PATH="${XDG_CONFIG_HOME:-${HOME}/.config}/${CONFIG_DIRNAME}"
CONFIG_FILE="${CONFIG_PATH}/${FILE_NAME}.conf"              # –ö–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª
LIST_FILE="${CONFIG_PATH}/${FILE_NAME}.list"                # –§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–∞–ø–æ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#
# –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥
#
# shellcheck disable=SC2034
{
    SHOW_LOG="LOG"                              # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
    SHOW_DEST="SHOW_DEST"                       # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç dest-—Å—Ç—Ä–æ–∫—É
    SHOW_TEST="TEST"                            # –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    SHOW_CLOUD_STAT="SHOW_CLOUD_STAT"           # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
    SHOW_CLOUD_CMD="SHOW_CLOUD_CMD"             # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É —Å–µ—Ä–≤–µ—Ä–∞
    SYNC_CMD_REGULAR="REGULAR"
    SYNC_CMD_UP="UP"
    SYNC_CMD_DL="DL"
    SYNC_CMD_UP_INIT="UP_INIT"
    SYNC_CMD_DL_INIT="DL_INIT"
    SYNC_CMD_PAUSE="PAUSE"
    SYNC_CMD_UP_EDIT="UP_EDIT"
    SYNC_CMD_UNPAUSE="UNPAUSE"
    SYNC_CMD_CLOUD_UP_INIT="CLOUD_UP_INIT"      # –°–æ–∑–¥–∞—ë—Ç sync-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏. 
    SYNC_CMD_CLOUD_DL_INIT="CLOUD_DL_INIT"      # –ó–∞–≥—Ä—É–∂–∞–µ—Ç sync-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É. –ë–ª–∏–∑–∫–æ –∫ DL_INIT
}



##
##  [CONFIG START] ============================================================================
##  –ù–∞—á–∞–ª–æ —Å–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞
##

##
##  –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ –°–ª—É—à–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞. 
##  VERSION 0.4.0-alfa (2025-12-26)
##
##  APP_PATH                                # –ü—É—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
##

LOG_PREFIX="SYNC_ALL"                       # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ª–æ–≥–µ
APP_S1="${APP_PATH}/sync_1.sh"              # –ü—Ä–æ–≥—Ä–∞–º–º–∞-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä

APP_INOTIFYWAIT="/usr/bin/inotifywait"      # –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
APP_INOTIFYWAIT_PKG="inotify-tools"         # –ø–∞–∫–µ—Ç, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å

APP_AWK="/usr/bin/awk"                      # –ø–æ—Ç–æ–∫–æ–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
APP_AWK_PKG="gawk"                          # –ø–∞–∫–µ—Ç, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å

PRE_SYNC=1                                  # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–ª—É—à–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
WAIT_CHANGES=60                             # –í—Ä–µ–º—è –æ–∂–∏–¥–Ω–∏—è –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

DRY_RUN=0                                   # –†–µ–∂–∏–º –∏–º–∏—Ç–∞—Ü–∏–∏, –±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
VERBOSE=0                                   # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å—è–∫–æ–π —Ñ–∏–≥–Ω–∏

#
# –®–∞–±–ª–æ–Ω—ã —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
#
IGNORE_PATTERNS=(
    '^\.sync_'          # —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è –Ω–∞ .sync_
    '\.swp$'            # swap-—Ñ–∞–π–ª—ã
    '\.tmp$'            # –≤—Ä–µ–º–µ–Ω–Ω—ã–µ
    '\.bak$'            # —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ
    '\.zim-new~$'       # –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª zim
    '(^|/)\.sync/'      # –ª—é–±—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ .sync (–≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –ø—É—Ç–∏)
    '\.~lock\.'         # –§–∞–π–ª—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –æ—Ñ–∏—Å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    '\.git/index\.lock' # –§–∞–π–ª git –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    '\.git/'            # –ü–∞–ø–∫–∞ git
)

#
#  –¶–≤–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
#
COLOR_FILENAME="\033[1;36m"     # –î–ª—è –≤—ã–≤–æ–¥–∞ –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤ –∏ –ø—É—Ç–µ–π (–±–∏—Ä—é–∑–æ–≤—ã–π —Ç–µ–º–Ω–µ–µ)
COLOR_STATUS="\033[0;36m"       # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç—É—Å–∞ (–±–∏—Ä—é–∑–æ–≤—ã–π)
COLOR_USAGE="\033[1;34m"        # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é (—Å–∏–Ω–∏–π —è—Ä—á–µ)
COLOR_INFO="\033[0;34m"         # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –ø—Ä–∏—á–∏–Ω–µ –≤—ã—Ö–æ–¥–∞) (—Å–∏–Ω–∏–π)
COLOR_OK="\033[0;32m"           # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ Ok-—Å–æ–æ–±—â–µ–Ω–∏—è (–∑–µ–ª—ë–Ω—ã–π)
COLOR_ERROR="\033[0;31m"        # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫ (–∫—Ä–∞—Å–Ω—ã–π)
COLOR_WARNING="\033[0;33m"      # –î–ª—è –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (–∂—ë–ª—Ç—ã–π)
COLOR_RED="\033[0;31m"          # –î–ª—è –≤—ã–≤–æ–¥–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–∫—Ä–∞—Å–Ω—ã–π)
COLOR_OFF="\033[0m"             # –°–±—Ä–æ—Å —Ü–≤–µ—Ç–∞

#
# –ü—Ä–æ–≥—Ä–∞–º–º–∞-—Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ –∏ —Ñ–∞–π–ª–∞-—Å–ø–∏—Å–∫–∞ –ø–∞–ø–æ–∫ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
# (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –ø—É—Ç–∏/–∏/–Ω–∞–∑–≤–∞–Ω–∏–∏)
EDITOR="nano"



##
##  –ö–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞
##  [CONFIG END] ----------------------------------------------------------------------------
##



#
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –≤–∏–¥–µ –∞—Å—Å–æ—Ü–∏–∞–ª–∏–≤–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
# [–ø—Ä–æ–≥—Ä–∞–º–º–∞]=–ø–∞–∫–µ—Ç
# –≥–¥–µ "–ø—Ä–æ–≥—Ä–∞–º–º–∞" -- —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ —Å–∞–º–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–∞—è –ø—Ä–æ–≥—Ä–∞–º–∞
#     "–ø–∞–∫–µ—Ç"     -- –ø–∞–∫–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —ç—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ 
#                    –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Å–∏—Å—Ç–º—É
declare -A DEPENDENCIES_REQUIRED=(
    ["${APP_INOTIFYWAIT}"]="${APP_INOTIFYWAIT_PKG}"
    ["${APP_AWK}"]="${APP_AWK_PKG}"
    ## ["${APP_ENVSUBST}"]="${APP_ENVSUBST_PKG}"
)



#
#  –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è logger -p info
#
log_info() {
    logger -p info -t "${LOG_PREFIX}" "$*"
}



#
#  –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è logger -p error
#
log_error() {
    logger -p error -t "${LOG_PREFIX}" "$*"
}



#
# –í—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ –∏ –≤—ã—Ö–æ–¥ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
# $1 -- —Å–æ–æ–±—â–µ–Ω–∏–µ
# $2 -- –∫–æ–¥ –æ—à–∏–±–∫–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é "1"
#
exit_with_msg() {
    local msg="${1:?–°—Ç—Ä–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞. –°–º–æ—Ç—Ä–µ—Ç—å –≤—ã–∑—ã–≤–∞—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é.}"
    local num="${2:-1}"
    case "${num}" in
    1)
        log_error "ERR: ${msg}"
        msg="[${COLOR_ERROR}–û—à–∏–±–∫–∞${COLOR_OFF}] ${msg}"
        ;;
    2)
        log_error "ERR: ${msg}"
        msg="[${COLOR_ERROR}–û—à–∏–±–∫–∞${COLOR_OFF}] ${msg}"
        msg="${msg}\n–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é: ${COLOR_USAGE}${APP_NAME} --usage|-u${COLOR_OFF}"
        ;;
    0)
        log_info "OK: ${msg}"
        msg="[${COLOR_OK}Ok${COLOR_OFF}] ${msg}"
        ;;
    *)
        log_info "${msg}"
        msg="[${COLOR_INFO}i${COLOR_OFF}] ${msg}"
        ;;
    esac
    echo -e "${msg}"
    exit "$num"
}



#
# –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–ø–µ—á–∞—Ç–∞–µ—Ç) –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏
#
get_abs_path() {
    local dir="${1:?}"
    # realpath –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º readlink -f, –∏–ª–∏ fallback
    if command -v realpath >/dev/null 2>&1; then
        realpath "$dir"
    elif command -v readlink >/dev/null 2>&1; then
        readlink -f "$dir"
    else
        # –ü—Ä–æ—Å—Ç–µ–π—à–∏–π fallback, –µ—Å–ª–∏ –Ω–µ—Ç realpath/readlink -f
        (cd "$dir" 2>/dev/null && pwd) || exit_with_msg "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É [$dir] (–í–æ–∑–º–æ–∂–Ω–æ –µ—ë –Ω–µ—Ç)."
    fi
}



#
#  –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª —Ñ—Ä–∞–≥–º–µ–Ω—Ç —ç—Ç–æ–≥–æ –∂–µ —Å–∫—Ä–∏–ø—Ç–∞ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ [–ö–û–ù–§–ò–ì –°–¢–ê–†–¢] –∏ [–ö–û–ù–§–ò–ì –ï–ù–î] 
#  –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
#       $0
#       $CONFIG_PATH
#       $CONFIG_FILE
#       $APP_AWK
#       $DRY_RUN
#
save_config_file()
{
    mkdir -p "${CONFIG_PATH}"
    echo  -e "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ '${COLOR_FILENAME}${CONFIG_FILE}${COLOR_OFF}'"
    if ! command -v "${APP_AWK}" >/dev/null 2>&1; then
        exit_with_msg "–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${COLOR_FILENAME}${APP_AWK}${COLOR_OFF}." 1
    fi
    # –ò–∑–≤–ª–µ—á—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç –º–µ–∂–¥—É [–ö–û–ù–§–ò–ì –°–¢–ê–†–¢] –∏ [–ö–û–ù–§–ò–ì –ï–ù–î] –∏–∑ —Å–∞–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    [[ $DRY_RUN -eq 0 ]] && "${APP_AWK}" '/\[\s*CONFIG START\s*\]/,/\[\s*CONFIG END\s*\]/' "$0" > "${CONFIG_FILE}"
}



#
#  –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
#  –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ.
#
read_config_file()
{
    #
    # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞
    # –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞—ë–º –µ–≥–æ
    # load_config()
    #
    if [ -f "${CONFIG_FILE}" ]; then
        # shellcheck source="${CONFIG_PATH}/${FILE_NAME}.conf"
        # shellcheck disable=SC1091
        source "${CONFIG_FILE}"
    else
        save_config_file
    fi
}



#
#  –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
#
check_dependencies_required() {
  local missing=()

  for cmd in "${!DEPENDENCIES_REQUIRED[@]}"; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
      missing+=("$cmd")
    fi
  done

  if [ "${#missing[@]}" -eq 0 ]; then
    echo -e "[${COLOR_OK}OK${COLOR_OFF}] –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
    return 0
  else
    echo -e "[${COLOR_ERROR}ERROR${COLOR_OFF}] –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:"
    for cmd in "${missing[@]}"; do
      local pkg="${DEPENDENCIES_REQUIRED[$cmd]}"
      echo -e "${COLOR_STATUS}  - $cmd (–ø–∞–∫–µ—Ç: ${pkg:-–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω})${COLOR_OFF}"
    done
    return 1
  fi
}



print_help()
{
echo -e "$(cat <<EOF
${APP_NAME}
${COLOR_USAGE}${APP_TITLE}${COLOR_OFF}
–°–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö
–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Å –ø–æ–º–æ—â—å—é sync_1.sh.

–ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

–í–ê–ñ–ù–û: 
–•–æ—Å—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç, —Å—á–∏—Ç–∞–µ—Ç–º—è "–≥–ª–∞–≤–Ω—ã–º" –≤ –≤–∞—à–µ–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. 
–¢–æ –µ—Å—Ç—å, –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö –Ω–∞ —ç—Ç–æ–º —Ö–æ—Å—Ç–µ,
–±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –ø–æ–º–æ—â–∏ sync_1.sh.

–ü–æ—ç—Ç–æ–º—É, –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –ø–∞–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º,
—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω, –µ–≥–æ –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä ${COLOR_USAGE}--presync${COLOR_OFF}.

–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

–ß–∏—Ç–∞–µ—Ç –∏–∑ —Ñ–∞–π–ª–∞ (${COLOR_FILENAME}$(basename "${LIST_FILE}")${COLOR_OFF}) —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫. 
–î–ª—è —ç—Ç–∏—Ö –ø–∞–ø–æ–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π ${COLOR_FILENAME}$(basename "${APP_INOTIFYWAIT}")${COLOR_OFF}.
–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä (${COLOR_FILENAME}$(basename "${APP_S1}")${COLOR_OFF}), 
—Ç–æ–ª—å–∫–æ –Ω–µ –≤ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ, –∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

–ü–æ—Å–∫–æ–ª—å–∫—É –í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç, —Ç–æ –í—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è 
(—Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –ò —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏.

–ü–æ —ç—Ç–æ–º—É, –≤–º–µ—Å—Ç–æ ${COLOR_STATUS}${SYNC_CMD_REGULAR}${COLOR_OFF} –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ${COLOR_STATUS}${SYNC_CMD_CLOUD_UP_INIT}${COLOR_OFF}
–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤ —Å—Ç–∞—Ç—É—Å–µ ${COLOR_STATUS}${SYNC_CMD_PAUSE}${COLOR_OFF}, —Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π ${COLOR_STATUS}${SYNC_CMD_UP_EDIT}${COLOR_OFF}

–í –∫–æ–Ω—Ñ–∏–≥–µ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

${COLOR_USAGE}WAIT_CHANGES${COLOR_OFF} -- —ç—Ç–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–Ω–∏—è –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, 
—á—Ç–æ–±—ã –Ω–µ –¥—ë—Ä–≥–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä –∫–∞–∂–¥—É—é—É —Å–µ–∫—É–Ω–¥—É, —É—á–∏—Ç—ã–≤–∞—è —á—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 
—Å–∞–º–∞ –ø–æ —Å–µ–±–µ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥, —Ç–æ –µ—Å—Ç—å —Å–º—ã—Å–ª —Å–æ–±—Ä–∞—Ç—å –∫–∞–∫–æ–µ-—Ç–æ 
–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –≤–º–µ—Å—Ç–µ.

–ú–∞—Å—Å–∏–≤ ${COLOR_USAGE}IGNORE_PATTERNS${COLOR_OFF} -- –≤–∫–ª—é—á–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ 
–Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ inotifywait –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å (.git-—Ñ–∞–π–ª—ã, —Ñ–∞–π–ª—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã).

${COLOR_INFO}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:${COLOR_OFF}
    ${APP_NAME} [–æ–ø—Ü–∏–∏]

${COLOR_INFO}–û–ø—Ü–∏–∏:${COLOR_OFF}
    ${COLOR_USAGE}--edit-conf, -ec${COLOR_OFF}  –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    ${COLOR_USAGE}--edit-list, -el${COLOR_OFF}  –û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    ${COLOR_USAGE}--dry-run, -n${COLOR_OFF}     –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥, –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
    ${COLOR_USAGE}--verbose, -v${COLOR_OFF}     –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
    ${COLOR_USAGE}--presync 1|0${COLOR_OFF}
    ${COLOR_USAGE}--presync=1|0${COLOR_OFF}     –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–ª—É—à–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                      –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${COLOR_USAGE}1${COLOR_OFF} (–≤—ã–ø–æ–ª–Ω–∏—Ç—å)
                      –ó–Ω–∞—á–µ–Ω–∏–µ ${COLOR_USAGE}0${COLOR_OFF} –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    ${COLOR_USAGE}--help, -h${COLOR_OFF}        –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ${COLOR_USAGE}--usage, -u${COLOR_OFF}       –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
    ${COLOR_USAGE}--version, -V${COLOR_OFF}     –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞

${COLOR_INFO}–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:${COLOR_OFF}
    –§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–∞–ø–æ–∫ ${COLOR_FILENAME}$(basename "${LIST_FILE}")${COLOR_OFF} –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—É—Ç–∏, –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–¥–∏–Ω –ø—É—Ç—å.
    –î–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, \$HOME), 
    –Ω–æ ${COLOR_ERROR}–∑–∞–ø—Ä–µ—â–µ–Ω–∞${COLOR_OFF} –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥: ${COLOR_USAGE}\`...\`${COLOR_OFF} –∏ ${COLOR_USAGE}\$()${COLOR_OFF}.

${COLOR_INFO}–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:${COLOR_OFF}
    –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ............... : ${COLOR_FILENAME}${CONFIG_FILE}${COLOR_OFF}
    –§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–ª—è —Å–ª–µ–∂–µ–Ω–∏—è .... : ${COLOR_FILENAME}${LIST_FILE}${COLOR_OFF}

${COLOR_INFO}–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ:${COLOR_OFF}
    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä ................... : ${COLOR_FILENAME}${APP_S1}${COLOR_OFF}
    –°–ª—É—à–∞—Ç–µ–ª—å —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π ...... : ${COLOR_FILENAME}${APP_INOTIFYWAIT}${COLOR_OFF}
    –Ø–∑—ã–∫–æ–≤–æ–π —Å–∫–∞–Ω–µ—Ä, –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è 
    —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ ....... : ${COLOR_FILENAME}${APP_AWK}${COLOR_OFF}

${COPYRIGHT}

EOF
)";
}



print_usage()
{
    echo -e "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ${COLOR_USAGE}${APP_NAME} [–æ–ø—Ü–∏–∏]${COLOR_OFF}"
    echo -e "    –ü–æ–¥—Ä–æ–±–Ω–µ–µ: ${COLOR_USAGE}${APP_NAME} --help${COLOR_OFF}"
}



print_version()
{
    echo -e "${COLOR_STATUS}${APP_NAME}${COLOR_OFF} ‚Äî ${APP_TITLE}"
    echo -e "${COLOR_INFO}–í–µ—Ä—Å–∏—è:${COLOR_OFF} ${VERSION}"
    echo -e "${LAST_CHANGES}"
}


print_banner() {
echo -e "$(cat <<EOF
${COLOR_WARNING}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${COLOR_OFF}
${COLOR_WARNING}‚ïë                                                                               ‚ïë${COLOR_OFF}
${COLOR_WARNING}‚ïë${COLOR_OFF}                                   ${COLOR_WARNING}–í–ê–ñ–ù–û:${COLOR_OFF}                                      ${COLOR_WARNING}‚ïë${COLOR_OFF}
${COLOR_WARNING}‚ïë                                                                               ‚ïë${COLOR_OFF}
${COLOR_WARNING}‚ïë${COLOR_OFF}        ${COLOR_INFO}–≠—Ç–æ—Ç ${COLOR_WARNING}—Ö–æ—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è "–≥–ª–∞–≤–Ω—ã–º"${COLOR_OFF}${COLOR_INFO} –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.${COLOR_OFF}           ${COLOR_WARNING}‚ïë${COLOR_OFF} 
${COLOR_WARNING}‚ïë${COLOR_OFF}              ${COLOR_INFO}–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —ç—Ç–æ–º —Ö–æ—Å—Ç–µ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö${COLOR_OFF}                   ${COLOR_WARNING}‚ïë${COLOR_OFF}
${COLOR_WARNING}‚ïë${COLOR_OFF}     ${COLOR_INFO}–±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π${COLOR_OFF} ${COLOR_WARNING}UP_INIT${COLOR_INFO}/${COLOR_WARNING}UP_EDIT${COLOR_OFF}       ${COLOR_WARNING}‚ïë${COLOR_OFF}
${COLOR_WARNING}‚ïë                                                                               ‚ïë${COLOR_OFF}
${COLOR_WARNING}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${COLOR_OFF}
EOF
)";
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -ec|--edit-conf)
                echo "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞: ${CONFIG_FILE}"
                exec ${EDITOR} "${CONFIG_FILE}"
                exit 0;
                ;;
            -el|--edit-list)
                echo "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞: ${LIST_FILE}"
                exec "${EDITOR}" "${LIST_FILE}"
                exit 0;
                ;;
            -n|--dry-run)
                DRY_RUN=1
                ;;
            -v|--verbose)
                VERBOSE=1
                ;;
            --presync=*)
                PRE_SYNC="${1#*=}"
                ;;
            --presync)
                shift
                [[ $# -gt 0 ]] || exit_with_msg "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è --presync" 2
                PRE_SYNC="$1"
                ;;
            -h|--help)
                print_help
                exit 0
                ;;
            -u|--usage)
                print_usage
                exit 0
                ;;
            -V|--version)
                print_version
                exit 0
                ;;
            *)
                exit_with_msg "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: ${COLOR_USAGE}$1${COLOR_OFF}" 2
                ;;
        esac
        shift
    done

    # –í–∞–ª–∏–¥–∞—Ü–∏—è PRESYNC (–æ–¥–∏–Ω —Ä–∞–∑, —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ)
    if [[ -n ${PRE_SYNC+x} ]]; then
        case "${PRE_SYNC}" in
            0|1) ;;
            *)
                exit_with_msg "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ --presync=${PRE_SYNC} (–æ–∂–∏–¥–∞–µ—Ç—Å—è 0 –∏–ª–∏ 1)" 2
                ;;
        esac
    fi

}



#
# –ú–∞—Å—Å–∏–≤ –ø—É—Ç–µ–π –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
#
WATCH_DIRS=()



#
# –ß—Ç–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–ø–∞–æ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
#
read_watch_folders()
{
    local line;

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    [[ -f "${LIST_FILE}" ]] || {
        exit_with_msg "–§–∞–π–ª —Å–ø–∏—Å–∫–∞ ${LIST_FILE} –Ω–µ –Ω–∞–π–¥–µ–Ω" 1
    }

    while IFS= read -r line || [[ -n "$line" ]]; do
        # –£–¥–∞–ª–∏—Ç—å –≤–µ–¥—É—â–∏–µ –∏ —Ö–≤–æ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–±–µ–ª—ã
        line="${line#"${line%%[![:space:]]*}"}"
        line="${line%"${line##*[![:space:]]}"}"

        # –ü—Ä–æ–ø—É—Å–∫ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Å –≤–µ–¥—É—â–∏–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏)
        [[ -z "$line" || "${line:0:1}" == "#" ]] && continue

        # –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–º–∞–Ω–¥: $(...) –∏–ª–∏ `...`
        if [[ "$line" == *'$'* && ( "$line" == *'('* || "$line" == *')'* || "$line" == *'\`'* ) ]]; then
            exit_with_msg "–ò–ù–™–ï–ö–¶–ò–Ø: –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –≤ —Å—Ç—Ä–æ–∫–µ: ${COLOR_FILENAME}${line}${COLOR_OFF}" 1
        fi

        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        line=$(echo "$line" | envsubst)

        # –£–¥–∞–ª–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        line="${line%\"}"
        line="${line#\"}"

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if [[ ! -d "$line" ]]; then
            exit_with_msg "–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø–∞–ø–∫–∞: ${COLOR_FILENAME}${line}${COLOR_OFF}\n\
            –ò—Å–ø—Ä–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${COLOR_FILENAME}${LIST_FILE}${COLOR_OFF}." 1
        fi

        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –≤ –º–∞—Å—Å–∏–≤
        WATCH_DIRS+=("$line")
    done < "${LIST_FILE}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –µ—Å—Ç—å —á—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å
    if [[ ${#WATCH_DIRS[@]} -eq 0 ]]; then
        exit_with_msg "–ù–µ—Ç –ø–∞–ø–æ–∫ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª-—Å–ø–∏—Å–æ–∫ ${COLOR_FILENAME}${LIST_FILE}${COLOR_OFF}." 1
    else
        echo -e "–°—á–∏—Ç–∞–Ω–æ –ø–∞–ø–æ–∫: ${COLOR_INFO}${#WATCH_DIRS[@]}${COLOR_OFF}"
    fi
}



#
#
#
#  ======================================== MAIN ========================================
#
#
#



print_banner

read_config_file

[[ ${VERBOSE} -eq 1 ]] && {
    echo -e "[${COLOR_INFO}ii${COLOR_OFF}] –ö–æ–Ω—Ñ–∏–≥: '${COLOR_FILENAME}${CONFIG_FILE}${COLOR_OFF}'";
    echo -e "[${COLOR_INFO}ii${COLOR_OFF}] –°–ø–∏—Å–æ–∫: '${COLOR_FILENAME}${LIST_FILE}${COLOR_OFF}'";
    echo -e "[${COLOR_INFO}ii${COLOR_OFF}] sync_1: '${COLOR_FILENAME}${APP_S1}${COLOR_OFF}'";
}

parse_args "$@"

check_dependencies_required

read_watch_folders

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
if [[ ${PRE_SYNC} -eq 1 ]]; then
    echo -e "${COLOR_INFO}===> –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...${COLOR_OFF}"
    for dir in "${WATCH_DIRS[@]}"; do
        echo -e "${COLOR_INFO}===> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∞–ø–∫–∏: ${COLOR_FILENAME}${dir}${COLOR_OFF}${COLOR_USAGE}...${COLOR_OFF}"
        if [[ ${VERBOSE} -eq 1 ]]; then
            "${APP_S1}" "${dir}" "${SYNC_CMD_REGULAR}" --verbose
        else
            "${APP_S1}" "${dir}" "${SYNC_CMD_REGULAR}"
        fi
    done
    echo -e "${COLOR_INFO}===> –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.${COLOR_OFF}"
else
    echo -e "${COLOR_INFO}===> –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞.${COLOR_OFF}"
fi

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–∞–µ–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo -e "${COLOR_INFO}===> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–ª–µ–¥—É—é—â–∏—Ö –ø–∞–ø–æ–∫:${COLOR_OFF}"
for dir in "${WATCH_DIRS[@]}"; do
    cloud_stat="$("${APP_S1}" "${dir}" "${SHOW_CLOUD_STAT}")" || { exit_with_msg "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞" 1; }
    cloud_cmd="$("${APP_S1}" "${dir}" "${SHOW_CLOUD_CMD}")" || { exit_with_msg "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞" 1; }
    printf "     ${COLOR_FILENAME}%-30s${COLOR_OFF} | CLOUD STAT: ${COLOR_STATUS}%-8s${COLOR_OFF} | CLOUD CMD: ${COLOR_STATUS}%-8s${COLOR_OFF} |\n" "$dir" "${cloud_stat}" "${cloud_cmd}"
done
echo -e "${COLOR_INFO}===> Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞${COLOR_OFF}"



##
##  ========================================  –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª  ========================================
##
inotifywait -r -m -e modify,create,delete,move --format '%w|%e|%f' "${WATCH_DIRS[@]}" | while IFS='|' read -r path action file; do
    
    # ‚õîÔ∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ/–≤—Ä–µ–º–µ–Ω–Ω—ã–µ/—Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã
    for pattern in "${IGNORE_PATTERNS[@]}"; do
        if [[ "${path}${file}" =~ $pattern ]]; then
            [[ ${VERBOSE} -eq 1 ]] && echo -e "$(date '+%H:%M:%S') ‚õîÔ∏è ${COLOR_INFO}–ü—Ä–æ–ø—É—â–µ–Ω –ø–æ —à–∞–±–ª–æ–Ω—É '${pattern}': ${COLOR_FILENAME}${path}${file}${COLOR_OFF}";
            continue 2
        fi
    done

    echo -e "\nüü° –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ"
    echo -e "${COLOR_USAGE}$(date +'%F %T')${COLOR_OFF} | ${COLOR_INFO}${action}${COLOR_OFF} ‚Üí ${COLOR_FILENAME}${path}${file}${COLOR_OFF}"

    # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ
    local_event_dir=$(get_abs_path "$path")

        # –ù–∞–π—Ç–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É –∏–∑ WATCH_DIRS, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–±—ã—Ç–∏–µ
    parent_sync_dir=""
    for watch_dir in "${WATCH_DIRS[@]}"; do
        abs_watch_dir=$(get_abs_path "${watch_dir}")
        if [[ "${local_event_dir}" == "${abs_watch_dir}"* ]]; then
            parent_sync_dir="$abs_watch_dir"
            break
        fi
    done

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–æ–ø—É—Å–∫
    if [[ -z "$parent_sync_dir" ]]; then
        echo -e "${COLOR_ERROR}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è:${COLOR_OFF} ${COLOR_FILENAME}${local_event_dir}${COLOR_OFF}"
        continue
    fi

    cloud_stat="$("${APP_S1}" "${parent_sync_dir}" "${SHOW_CLOUD_STAT}")" || { exit_with_msg "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–∞–ø–∫–∏ '${path}'" 1; }
    cloud_cmd="$("${APP_S1}" "${parent_sync_dir}" "${SHOW_CLOUD_CMD}")" || { exit_with_msg "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–∞–ø–∫–∏ '${path}'" 1; }
    # echo -e "CMD_CLOUD: ${cloud_cmd}"

    case "${cloud_stat}" in
        "${SYNC_CMD_REGULAR}")
            cmd=("${APP_S1}" "${parent_sync_dir}" "${SYNC_CMD_UP_INIT}")
            ;;
        "${SYNC_CMD_PAUSE}")
            cmd=("${APP_S1}" "${parent_sync_dir}" "${SYNC_CMD_UP_EDIT}")
            ;;
        *)
            cmd=()
            ;;
    esac


    if ((${#cmd[@]})); then
        # –ü –æ–∫–∞–∑–∞—Ç—å –∫–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
        echo -e "RUN: ${COLOR_INFO}${cmd[*]}${COLOR_OFF}"
        # –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã
        echo -e "–ß–µ—Ä–µ–∑ ${COLOR_INFO}${WAIT_CHANGES} —Å–µ–∫${COLOR_OFF} –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."
        sleep "${WAIT_CHANGES}"

        {   # –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú
            trap '' SIGINT  # –í—ã–∫–ª—é—á–∏—Ç—å –ª–æ–≤–ª—é Ctrl+C
            "${cmd[@]}"
            trap - SIGINT   # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–≤–ª—é Ctrl+C
        }
    else
        printf "     ${COLOR_FILENAME}%-30s${COLOR_OFF} | CLOUD STAT: ${COLOR_STATUS}%s${COLOR_OFF} | CLOUD CMD: ${COLOR_STATUS}%s${COLOR_OFF}\n" \
                "$parent_sync_dir" "${cloud_stat}" "${cloud_cmd}"
    fi

    echo -e "==== End UP [ ${COLOR_INFO}Ctrl+C${COLOR_OFF} to stop ] ===="
done

