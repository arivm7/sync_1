#!/usr/bin/env bash
set -euo pipefail



APP_TITLE="–°–∫—Ä–∏–ø—Ç –º–∞—Å—Å–æ–≤–æ–π —Å–∏—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ß–∞—Å—Ç—å –ø–∞–∫–µ—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ sync_1"
VERSION="1.3.1 (2025-05-23)"
LAST_CHANGES="\
v1.2.6 (2025-04-25): –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ run_one_dir()
v1.2.7 (2025-05-08): –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä LOG –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
v1.3.0 (2025-05-17): –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä SHOW_DEST –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–ª–∞—á–Ω—ã–µ –ø—É—Ç–∏
v1.3.1 (2025-05-23): –ü–æ—á–∏–Ω–∫–∞ —Ç–æ–≥–æ, —á—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç—Ä–∏–Ω–≥–∞ sync_1
"

APP_NAME=$(basename "$0")
APP_PATH=$(dirname "$0")

SYNC_ALL_LIST_FILE="sync_all.list"  # –ö–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–∞–ø–æ–∫ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
SYNC1="sync_1.sh"                   # —Å–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä

LOG_PREFIX="SYNC_ALL: "             # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ª–æ–≥–µ
LOG_COUNT_ROWS="20"                 # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –ª–æ–≥–æ–≤
VERB_MODE=true                      # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π. –ï—Å–ª–∏ false -- —Ç–æ "—Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º"
WAIT_END=5                          # seconds –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏



# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–º–∞–Ω–¥—ã
SHOW_LOG="LOG"
SHOW_DEST="SHOW_DEST"                   # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç dest-—Å—Ç—Ä–æ–∫—É
SYNC_CMD_REGULAR="REGULAR"
SYNC_CMD_UP="UP"
SYNC_CMD_DL="DL"
SYNC_CMD_UP_INIT="UP_INIT"
SYNC_CMD_DL_INIT="DL_INIT"
SYNC_CMD_PAUSE="PAUSE"
SYNC_CMD_UP_EDIT="UP_EDIT"
SYNC_CMD_UNPAUSE="UNPAUSE"



log_info() {
    logger -p info "${LOG_PREFIX} $*"
}



print_help()
{
cat << EOF
${APP_TITLE}
–°–∫—Ä–∏–ø—Ç: ${APP_NAME} –í–µ—Ä—Å–∏—è: ${VERSION}
–ü–∞–ø–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: "${APP_PATH}"

–°–∫—Ä–∏–ø—Ç –º–∞—Å—Å–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–∞–ø–æ–∫.
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ–º–ø–ª–µ–∫—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ sync_1.
–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ —Ä–∞–±–æ—Ç–µ —Å–º. –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç "sync_1.sh --help"

–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞ ${SYNC_ALL_LIST_FILE}
–≤ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –ø–∞–ø–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 
–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ-–±–∞–Ω–Ω–µ—Ä –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ª–æ–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    ${APP_NAME} [${SYNC_CMD_REGULAR}|${SYNC_CMD_UP}|${SYNC_CMD_DL}|${SYNC_CMD_UP_INIT}|${SYNC_CMD_DL_INIT}|${SYNC_CMD_PAUSE}|${SYNC_CMD_UP_EDIT}|${SYNC_CMD_UNPAUSE}|${SHOW_DEST}] 

    ${SYNC_CMD_REGULAR} -- –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –£–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
               –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä (${SYNC_CMD_UP}) –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ (${SYNC_CMD_DL}) 
               –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π.
    ${SYNC_CMD_UP}      -- –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è.
    ${SYNC_CMD_DL}      -- –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è.
    ${SYNC_CMD_DL_INIT} -- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç 
               —Å *—É–¥–∞–ª–µ–Ω–∏–µ–º* —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ.
    $SYNC_CMD_UP_INIT -- –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä 
               —Å *—É–¥–∞–ª–µ–Ω–∏–µ–º* —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤ 
               —Å—Ç–∞—Ç—É—Å–∞ ${SYNC_CMD_DL_INIT} –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
    ${SYNC_CMD_PAUSE}   -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
               –†–µ–∂–∏–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–∞–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ. 
               –ù–∏–∫–∞–∞—è –∫–æ–º–º–∞–Ω–¥–∞ —Å —Å–µ—Ä–µ—Ä–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç. 
               –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–º–∞–Ω–¥–∞ ${SYNC_CMD_UP_EDIT}. 
    ${SYNC_CMD_UP_EDIT} -- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞.
               –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ ${SYNC_CMD_PAUSE}. 
               –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ ${SYNC_CMD_UP_INIT} —Ç–æ–ª—å–∫–æ –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.
    ${SYNC_CMD_UNPAUSE} -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
               –î–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å ${SYNC_CMD_DL_INIT} 
    ${SHOW_DEST} -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
               –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–æ–∫—É dest -- –∞–¥—Ä–µ—Å –ø–∞–ø–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. 

    ${APP_NAME} ${SHOW_LOG} <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Å—Ç—Ä–æ–∫>
               –ü–æ–∫–∞–∑—ã–≤–∞—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∏–∑ –ª–æ–≥-—Ñ–∞–π–ª–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—á—Ç–≤–æ = ${LOG_COUNT_ROWS}

–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
${LAST_CHANGES}
EOF
}



print_version()
{
    echo "${APP_TITLE}"
    echo "–°–∫—Ä–∏–ø—Ç       : ${APP_NAME}"
    echo "–í–µ—Ä—Å–∏—è       : ${VERSION}"
    echo "–ü—É—Ç—å —Å–∫—Ä–∏–ø—Ç–∞ : \"${APP_PATH}\""
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "${LAST_CHANGES}"
    echo ""
}



print_log() {
    local count="${1:-$LOG_COUNT_ROWS}"
    journalctl -p info --since today | grep -- "$LOG_PREFIX" || true | tail -n "$count"
}


#
# –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏.
# –° –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è —Å–∞–º–æ–π –ø–∞–ø–∫–∏, 
# –∏ –Ω–∞–ª–∏—á–∏—è –≤ –Ω–µ–π –ø–∞–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞ .sync
# —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∞–ø–∫–∏ `.sync` –∏ —Ñ–∞–π–ª–æ–≤ dest/excludes
#
run_one_dir() {
    local dir="${1:?–ü–∞–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞}"
    local sync_dir="$dir/.sync"
    local dest_file="$sync_dir/dest"
    local excludes_file="$sync_dir/excludes"

    [[ -f "$dest_file" ]] || { echo "–ù–µ—Ç —Ñ–∞–π–ª–∞ [$dest_file]"; return 1; }
    [[ -f "$excludes_file" ]] || { echo "–ù–µ—Ç —Ñ–∞–π–ª–∞ [$excludes_file]"; return 1; }

    if [[ -z "${USER_CMD:-}" ]]; then
        "$SYNC1" "$dir" < /dev/null
    else
        "$SYNC1" "$dir" "$USER_CMD" < /dev/null
    fi
}



#
# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 
# –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–æ–º–∞–Ω–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –ø–µ—Ä–µ–∑ –∑–∞–ø—É—Å–∫–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
#
run_banner() {
    local folder="${1:?}"
    local banner="${2:-$folder}"

    if [[ "$VERB_MODE" == true ]]; then
        printf "\n\n\n\n"
        echo "$banner"
        command -v figlet &>/dev/null && figlet -k "$banner" -f big
    fi

    run_one_dir "$folder"
}



# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä—ã folder + banner –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
parse_sync_list() {
    local file="$1"
    [[ -f "$file" ]] || {
        echo "–§–∞–π–ª $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
        return 1
    }

    while IFS= read -r line_raw || [[ -n "$line_raw" ]]; do
        [[ -z "$line_raw" || "$line_raw" =~ ^[[:space:]]*# ]] && continue

        eval "set -- $line_raw"  # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–≤—ã—á–∫–∏
        echo "$1|${2:-$1}"
    done < "$file"
}



#
# üìå –°–ø–æ—Å–æ–±—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞:
# Escape-–∫–æ–¥	–û–ø–∏—Å–∞–Ω–∏–µ
# \033[A	–≤–≤–µ—Ä—Ö –Ω–∞ 1 —Å—Ç—Ä–æ–∫—É
# \033[B	–≤–Ω–∏–∑ –Ω–∞ 1 —Å—Ç—Ä–æ–∫—É
# \033[C	–≤–ø—Ä–∞–≤–æ –Ω–∞ 1 —Å–∏–º–≤–æ–ª
# \033[D	–≤–ª–µ–≤–æ –Ω–∞ 1 —Å–∏–º–≤–æ–ª
# \033[F	–≤ –Ω–∞—á–∞–ª–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç \033[A\r)
#
wait_end() {
    local seconds="${1:-${WAIT_END}}"
    local first=true
    while (( seconds >= 0 )); do
        if ! $first; then
            printf "\033[F\033[F\033[F\033[F\033[F\033[F"
        else
            first=false
        fi
        echo    "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo    "‚ïë                                                                               ‚ïë"
        echo    "‚ïë                     –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –û–∫–Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å.                        ‚ïë"
        printf  "‚ïë                     –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ [\e[0;31m%2d\e[0m] —Å–µ–∫.                   ‚ïë\n" "${seconds}"
        echo    "‚ïë                                                                               ‚ïë"
        echo    "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        # printf "\r–û–∫–Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ %2d —Å–µ–∫..." "$seconds"
        sleep 1
        ((seconds--))
    done
}



#
#
#
# ========== –ü–ê–†–°–ò–ù–ì –ê–†–ì–£–ú–ï–ù–¢–û–í ==========
#
#
#



[[ "${1:-}" =~ ^-h|--help$ ]] && { print_help; exit 0; }

[[ "${1:-}" =~ ^-v|--version$ ]] && { print_version; exit 0; }

#
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–º–∞–Ω–¥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ—ã–± –≤—Å–µ–º –ø–∞–ø–∫–∞–º –ø–µ—Ä–µ–¥–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É–± –∫–æ–º–∞–Ω–¥—É
# –Ω–∞–ø—Ä–∏–º–µ—Ä:
# sync_all.sh UP_INIT -- –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ 
#                        –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—É–∏–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö
# –†–ò–°–ö: –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–¥–∞–ª–∏—Ç —Ñ–∞–π–ª—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é–±—Ç–µ—Ä–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç —ç—Ç—É –∫–æ–º–º–∞–Ω–¥—É, 
#       —Ç–æ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—Ç—å—Å—è –Ω–∞ –≤—Å–µ—Ö –∫–ª–∏–Ω—Ç—Å–∫–∏—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. 
#       –•–æ—Ç—è, —Ç–∞–∫-–∂–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
# 
USER_CMD="${1:-}"



# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∫—Ä–∏–ø—Ç, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏–¥–µ—Ç—å –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª
SCRIPT_DIR=$(dirname "$(realpath "$0")")
cd "${SCRIPT_DIR}" || { 
    ERR="–ü–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å–∫—Ä–∏–ø–ª–∞ [${SCRIPT_DIR}] –Ω–µ —É–¥–∞–ª—Å—è."
    logger -p info "${LOG_PREFIX} ERR: ${ERR}"
    echo "${ERR}" ; 
    exit 1; 
} 



case "$USER_CMD" in
    "$SHOW_LOG") print_log "${2:-}"; exit 0 ;;

    #  –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ dest-—Å—Ç—Ä–æ–∫–∏, —Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "—Ç–∏—Ö–∏–π" —Ä–µ–∂–∏–º
    "$SHOW_DEST") VERB_MODE=false ;;

    ""|"$SYNC_CMD_REGULAR"|"$SYNC_CMD_UP"|"$SYNC_CMD_DL"|"$SYNC_CMD_UP_INIT"|"$SYNC_CMD_DL_INIT"|"$SYNC_CMD_PAUSE"|"$SYNC_CMD_UP_EDIT"|"$SYNC_CMD_UNPAUSE") ;;  # –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã

    *)
        log_info "–ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: [$USER_CMD]"
        echo "–ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: [$USER_CMD]"
        exit 2
        ;;
esac


log_info "BEG: $(date)"
log_info "VER: $VERSION"
# ${*@Q} ‚Äî —Ü–∏—Ç–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –∫–∞–∫ Bash-–ª–∏—Ç–µ—Ä–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, --opt="some val" ‚Üí '--opt=some val'), –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ª–æ–≥–æ–≤.
log_info "CMD: $0 ${*@Q}"
[[ "$VERB_MODE" == true ]] && echo "$APP_NAME VERSION $VERSION"


# ========== –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò –§–ê–ô–õ–û–í ==========



[[ -f "$SYNC_ALL_LIST_FILE" ]] || {
    echo "–§–∞–π–ª $SYNC_ALL_LIST_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
}


##  =================================================  ##
##                                                     ##
##  –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, —Ç—É—Ç –ø–µ—Ä–µ–±–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã—Ö –ø–∞–ø–æ–∫     ##
##                                                     ##

while IFS="|" read -r folder banner; do
    if ! run_banner "$folder" "$banner"; then
        err="–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–ø–∫–∏: $folder"
        echo     "$err" >&2
        log_info "ERR: $err"
    fi
done < <(parse_sync_list "$SYNC_ALL_LIST_FILE")

##                                                     ##
##  –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏                         ##
##                                                     ##
##  =================================================  ##



logger -p info "${LOG_PREFIX} END: $(date)"
[[ "$VERB_MODE" == true ]] && {
    wait_end "${WAIT_END}"
    # sleep ${WAIT_END}
};
