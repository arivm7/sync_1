#!/usr/bin/env bash
set -euo pipefail
trap 'logger -p error -t "SYNC_ALL" "[$(date)] –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ $LINENO: –∫–æ–º–∞–Ω–¥–∞ \"$BASH_COMMAND\""' ERR



# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –∑–∞–ø—É—Å–∫ –∏–∑ cron –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
# [[ ! -t 0 && ! -t 1 ]] –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ª–∏ stdin –∏ stdout –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª—É.
# –ï—Å–ª–∏ –æ–±–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã ‚Äî –ø–æ—á—Ç–∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ —ç—Ç–æ cron, systemd, –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ–Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫.
IS_CRON=false
if [[ ! -t 0 && ! -t 1 ]]; then
    IS_CRON=true
fi



APP_TITLE="–°–∫—Ä–∏–ø—Ç –º–∞—Å—Å–æ–≤–æ–π —Å–∏—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ß–∞—Å—Ç—å –ø–∞–∫–µ—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ sync_1"
VERSION="1.7.0 (2025-07-10)"
LAST_CHANGES="\
v1.2.6 (2025-04-25): –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ run_one_dir()
v1.2.7 (2025-05-08): –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä LOG –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
v1.3.0 (2025-05-17): –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä SHOW_DEST –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–ª–∞—á–Ω—ã–µ –ø—É—Ç–∏
v1.3.1 (2025-05-23): –ü–æ—á–∏–Ω–∫–∞ —Ç–æ–≥–æ, —á—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç—Ä–∏–Ω–≥–∞ sync_1
v1.3.2 (2025-06-02): –ü–µ—Ä–µ–Ω–æ—Å –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∞–∫—É –∫–æ–Ω—Ñ–∏–≥–æ–≤
v1.4.0 (2025-06-12): –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ TEST, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞
v1.6.0 (2025-06-27): –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–∏–≥ –∏ –∫–æ–º–∞–Ω–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ --edit-conf|-e
v1.7.0 (2025-07-10): –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–º–∞–Ω–¥—ã SHOW_CLOUD_CMD
"



APP_PATH=$(cd "$(dirname "$0")" && pwd)                     # –ü—É—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
APP_NAME=$(basename "$0")                                   # –ü–æ–ª–Ω–æ–µ –∏–º—è —Å–∫—Ä–∏–ø—Ç–∞, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
# shellcheck disable=SC2034
FILE_NAME="${APP_NAME%.*}"                                  # –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å), –Ω–∞–ø—Ä–∏–º–µ—Ä ".sh"
# shellcheck disable=SC2034
SCRIPT_NAME=$(basename "${BASH_SOURCE[0]}")                 # –ü–æ–ª–Ω–æ–µ –∏–º—è [–≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ] —Å–∫—Ä–∏–ø—Ç–∞, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
# shellcheck disable=SC2034
SCRIPT_PATH=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)   # –ü—É—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è [–≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ] —Å–∫—Ä–∏–ø—Ç–∞

CONFIG_DIRNAME="sync"
CONFIG_PATH="${XDG_CONFIG_HOME:-${HOME}/.config}/${CONFIG_DIRNAME}"
CONFIG_FILE="${CONFIG_PATH}/${FILE_NAME}.conf"
SYNC_ALL_LIST_FILE="${CONFIG_PATH}/${FILE_NAME}.list"       # –°–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

VERB_MODE=$([[ "$IS_CRON" == false ]] && echo true || echo false) # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π. –ï—Å–ª–∏ false -- —Ç–æ "—Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º"



##
##  ============================================================================
##  [CONFIG START] –ù–∞—á–∞–ª–æ —Å–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞
##

##
##  –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ sync_all. 
##  –ò–∑ –ø–∞–∫–µ—Ç–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ sync_1.
##  VERSION 1.0.0 (2025-06-26)
##

#
#  –î–æ–ø—É—Å—Ç–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–∏–ø–∞ ${HOME}
#

SYNC1="sync_1.sh"                   # —Å–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä

LOG_PREFIX="SYNC_ALL"               # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ª–æ–≥–µ
LOG_COUNT_ROWS=40                   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –ª–æ–≥–æ–≤
WAIT_END=5                          # seconds –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

COLOR_USAGE="\e[1;32m"              # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç—É—Å–∞
COLOR_ERROR="\e[0;31m"              # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫
COLOR_INFO="\e[0;34m"               # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –ø—Ä–∏—á–∏–Ω–µ –≤—ã—Ö–æ–¥–∞)
COLOR_FILENAME="\e[1;36m"         # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤
COLOR_OFF="\e[0m"                   # –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ü–≤–µ—Ç–∞

# –ü—Ä–æ–≥—Ä–∞–º–º–∞-—Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ –∏ —Å–ø–∏—Å–∫–∞ –ø–∞–ø–∞–æ–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
# (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –ø—É—Ç–∏/–∏/–Ω–∞–∑–≤–∞–Ω–∏–∏)
EDITOR="nano"


APP_AWK="/usr/bin/awk"
# VERB_MODE=1                               # –†–µ–∂–∏–º –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞. # –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
DRY_RUN=0                                   # –¢–æ–ª—å–∫–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å. –ë–µ–∑ —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

##
##  [CONFIG END] –ö–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞
##  ----------------------------------------------------------------------------
##


#
#  –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª —Ñ—Ä–∞–≥–º–µ–Ω—Ç —ç—Ç–æ–≥–æ –∂–µ —Å–∫—Ä–∏–ø—Ç–∞ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ [–ö–û–ù–§–ò–ì –°–¢–ê–†–¢] –∏ [–ö–û–ù–§–ò–ì –ï–ù–î] 
#  –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ 0 –∏ CONFIG_FILE
#
save_config_file()
{
    mkdir -p "${CONFIG_PATH}"
    echo  -e "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ '${COLOR_FILENAME}${CONFIG_FILE}${COLOR_OFF}'"
    if ! command -v "${APP_AWK}" >/dev/null 2>&1; then
        exit_with_msg "–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${COLOR_FILENAME}${APP_AWK}${COLOR_OFF}." 1
    fi
    # –ò–∑–≤–ª–µ—á—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç –º–µ–∂–¥—É [–ö–û–ù–§–ò–ì –°–¢–ê–†–¢] –∏ [–ö–û–ù–§–ò–ì –ï–ù–î] –∏–∑ —Å–∞–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    [[ $DRY_RUN -eq 0 ]] && "${APP_AWK}" '/\[\s*CONFIG START\s*\]/,/\[\s*CONFIG END\s*\]/' "$0" > "${CONFIG_FILE}"
}



#
#  –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
#  –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ.
#
read_config_file()
{
    #
    # –ü–µ—Ä–µ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞
    # –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞—ë–º –µ–≥–æ
    # load_config
    #
    if [ -f "${CONFIG_FILE}" ]; then
        # shellcheck source="${XDG_CONFIG_HOME:-${HOME}/.config}/${CONFIG_DIRNAME}}/${FILE_NAME}.conf"
        source "${CONFIG_FILE}"
    else
        save_config_file
    fi
}



# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–º–∞–Ω–¥—ã
SYNC_CMD_REGULAR="REGULAR"
SYNC_CMD_UP="UP"
SYNC_CMD_DL="DL"
SYNC_CMD_UP_INIT="UP_INIT"
SYNC_CMD_DL_INIT="DL_INIT"
SYNC_CMD_PAUSE="PAUSE"
SYNC_CMD_UP_EDIT="UP_EDIT"
SYNC_CMD_UNPAUSE="UNPAUSE"
SHOW_LOG="LOG"                      # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ª–æ–≥–∞
SHOW_DEST="SHOW_DEST"               # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç dest-—Å—Ç—Ä–æ–∫—É
SHOW_TEST="TEST"                    # –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
SHOW_CLOUD_CMD="SHOW_CLOUD_CMD"     # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É —Å–µ—Ä–≤–µ—Ä–∞

# –°–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥
VALID_COMMANDS=(
    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç
    "${SYNC_CMD_REGULAR}"
    "${SYNC_CMD_UP}"
    "${SYNC_CMD_DL}"
    "${SYNC_CMD_UP_INIT}"
    "${SYNC_CMD_DL_INIT}"
    "${SYNC_CMD_PAUSE}"
    "${SYNC_CMD_UP_EDIT}"
    "${SYNC_CMD_UNPAUSE}"
    # –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç
    "${SHOW_LOG}"
    "${SHOW_DEST}"
    "${SHOW_TEST}"
    "${SHOW_CLOUD_CMD}"
)




#
#  –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è logger -p info
#
log_info() {
    logger -p info -t "${LOG_PREFIX}" "$*"
}



#
#  –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è logger -p error
#
log_error() {
    logger -p error -t "${LOG_PREFIX}" "$*"
}



#
# –í—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ –∏ –≤—ã—Ö–æ–¥ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
# $1 -- —Å–æ–æ–±—â–µ–Ω–∏–µ
# $2 -- –∫–æ–¥ –æ—à–∏–±–∫–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é "1"
#
exit_with_msg() {
    local msg="${1:?–°—Ç—Ä–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞. –°–º–æ—Ç—Ä–µ—Ç—å –≤—ã–∑—ã–≤–∞—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é.}"
    local num="${2:-1}"
    case "${num}" in
    1)
        log_error "ERR: ${msg}"
        msg="[${COLOR_ERROR}–û—à–∏–±–∫–∞${COLOR_OFF}] ${msg}"
        ;;
    2)
        log_error "ERR: ${msg}"
        msg="[${COLOR_ERROR}–û—à–∏–±–∫–∞${COLOR_OFF}] ${msg}"
        msg="${msg}\n–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é: ${COLOR_USAGE}${APP_NAME} --usage|-u${COLOR_OFF}"
        ;;
    0)
        log_info "OK: ${msg}"
        msg="[${COLOR_OK}Ok${COLOR_OFF}] ${msg}"
        ;;
    *)
        log_info "${msg}"
        msg="[${COLOR_INFO}i${COLOR_OFF}] ${msg}"
        ;;
    esac
    echo -e "${msg}"
    exit "$num"
}



#
#  –ü–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ —Å–∫—Ä–∏–ø—Ç—É
#
print_help()
{
cat << EOF
${APP_TITLE}
–°–∫—Ä–∏–ø—Ç: ${APP_NAME} –í–µ—Ä—Å–∏—è: ${VERSION}
–ü–∞–ø–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: "${APP_PATH}"

–°–∫—Ä–∏–ø—Ç –º–∞—Å—Å–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–∞–ø–æ–∫.
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ–º–ø–ª–µ–∫—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ sync_1.
–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ —Ä–∞–±–æ—Ç–µ —Å–º. –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç "sync_1.sh --help"

–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞ ${SYNC_ALL_LIST_FILE}
–≤ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –ø–∞–ø–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 
–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ-–±–∞–Ω–Ω–µ—Ä –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ª–æ–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    ${APP_NAME}  [ $(str=$(IFS="|"; echo "${VALID_COMMANDS[*]:0:5}"); echo "${str//|/ | }";) ]
                 [ $(str=$(IFS="|"; echo "${VALID_COMMANDS[*]:5:3}"); echo "${str//|/ | }";) ]
                 [ $(str=$(IFS="|"; echo "${VALID_COMMANDS[*]:8}");  echo "${str//|/ | }";) ]
                 –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${SYNC_CMD_REGULAR}

    ${SYNC_CMD_REGULAR}   -- –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –£–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
                 –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä (${SYNC_CMD_UP}) –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ (${SYNC_CMD_DL}) 
                 –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π.
                 
    ${SYNC_CMD_UP}        -- –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è.

    ${SYNC_CMD_DL}        -- –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è.

    ${SYNC_CMD_DL_INIT}   -- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç 
                 —Å *—É–¥–∞–ª–µ–Ω–∏–µ–º* —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ.

    $SYNC_CMD_UP_INIT   -- –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä 
                 —Å *—É–¥–∞–ª–µ–Ω–∏–µ–º* —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤ 
                 —Å—Ç–∞—Ç—É—Å–∞ ${SYNC_CMD_DL_INIT} –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

    ${SYNC_CMD_PAUSE}     -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
                 –†–µ–∂–∏–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–∞–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ. 
                 –ù–∏–∫–∞–∞—è –∫–æ–º–º–∞–Ω–¥–∞ —Å —Å–µ—Ä–µ—Ä–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç. 
                 –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–º–∞–Ω–¥–∞ ${SYNC_CMD_UP_EDIT}. 

    ${SYNC_CMD_UP_EDIT}   -- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞.
                 –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ ${SYNC_CMD_PAUSE}. 
                 –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ ${SYNC_CMD_UP_INIT} —Ç–æ–ª—å–∫–æ –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.

    ${SYNC_CMD_UNPAUSE}   -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
                 –î–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å ${SYNC_CMD_DL_INIT} 

    ${SHOW_DEST} -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
                 –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–æ–∫—É dest -- –∞–¥—Ä–µ—Å –ø–∞–ø–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. 

    ${SHOW_CLOUD_CMD} -- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
                 –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–º–∞–Ω–¥ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –ø–∞–ø–æ–∫
                 
    ${SHOW_TEST}      -- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞.
                 –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
                 –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä—É—Ç–∫—É—Ä—É 
                 –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–∞–ø–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. 

    ${SHOW_LOG} [<–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Å—Ç—Ä–æ–∫>]
                 –ü–æ–∫–∞–∑—ã–≤–∞—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∏–∑ –ª–æ–≥-—Ñ–∞–π–ª–∞. 
                 –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–∏—á–µc—Ç–≤–æ = ${LOG_COUNT_ROWS}

    --help    | -h      –≠—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ
    --usage   | -u      –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
    --version | -v      –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞
    --edit-conf         –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
    --edit-list         –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–í–ê–ñ–ù–û:
–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ –≤ crontab –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ cron-—Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, 
               –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã —ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç—É, –∏ –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—Å—É—Ç—Å–≤—É—é—Ç –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ 
               –Ω–µ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏: cron, systemd, –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ–Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫.
               –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:

               USER=${USER}
               HOME=${HOME}
               PATH=/usr/local/bin:/usr/bin:/bin:${HOME}/bin:${HOME}/.local/bin
               SHELL=/bin/bash
               BASH_ENV=${HOME}/.bashrc

               1  *  *  *  *    ${HOME}/bin/sync_all.sh

               –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∞–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:
               1  *  *  *  *    ${HOME}/bin/sync_all.sh >> ${HOME}/sync_all_cron.log 2>&1

–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
${LAST_CHANGES}
EOF
}



#
#  –ö—Ä–∞—Ç–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
#
print_usage()
{
cat << EOF
${APP_TITLE}
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    ${APP_NAME}  [ $(str=$(IFS="|"; echo "${VALID_COMMANDS[*]:0:5}"); echo "${str//|/ | }";) ]
                 [ $(str=$(IFS="|"; echo "${VALID_COMMANDS[*]:5:3}"); echo "${str//|/ | }";) ]
                 [ $(str=$(IFS="|"; echo "${VALID_COMMANDS[*]:8}");  echo "${str//|/ | }";) ]
                 –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${SYNC_CMD_REGULAR}
                 [ --help | -h | --usage | -u | --version | -v ]
                 [ --edit-conf | --edit-list ]
                 [ ${SHOW_LOG} <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Å—Ç—Ä–æ–∫> ]
EOF
}



#
#  –í—ã–≤–æ–¥ –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞
#
print_version()
{
    echo "${APP_TITLE}"
    echo "–°–∫—Ä–∏–ø—Ç       : ${APP_NAME}"
    echo "–í–µ—Ä—Å–∏—è       : ${VERSION}"
    echo "–ü—É—Ç—å —Å–∫—Ä–∏–ø—Ç–∞ : \"${APP_PATH}\""
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "${LAST_CHANGES}"
    echo ""
}



#
#  –í—ã–≤–æ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ª–æ–≥–∞
#
print_log() {
    local count="${1:-${LOG_COUNT_ROWS}}"
    # journalctl -p info --since "2 days ago" | grep -- "$LOG_PREFIX" || true | tail -n "$count"
    # journalctl -t "${LOG_PREFIX}" --since "2 days ago" || true | tail -n "$count"
    journalctl -t "${LOG_PREFIX}" -n "$count"

}



#
# –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏.
# –° –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è —Å–∞–º–æ–π –ø–∞–ø–∫–∏, 
# –∏ –Ω–∞–ª–∏—á–∏—è –≤ –Ω–µ–π –ø–∞–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞ .sync
# —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∞–ø–∫–∏ `.sync` –∏ —Ñ–∞–π–ª–æ–≤ dest/excludes
#
run_one_dir() {
    local dir="${1:?–ü–∞–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞}"
    local sync_dir="$dir/.sync"
    local dest_file="$sync_dir/dest"
    local excludes_file="$sync_dir/excludes"

    [[ -f "$dest_file" ]] || { echo "–ù–µ—Ç —Ñ–∞–π–ª–∞ [$dest_file]"; return 1; }
    [[ -f "$excludes_file" ]] || { echo "–ù–µ—Ç —Ñ–∞–π–ª–∞ [$excludes_file]"; return 1; }

    if [[ -z "${USER_CMD:-}" ]]; then
        "$SYNC1" "$dir" < /dev/null
    else
        "$SYNC1" "$dir" "$USER_CMD" < /dev/null
    fi
}



#
#  –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 
#  –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–æ–º–∞–Ω–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
#  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –ø–µ—Ä–µ–∑ –∑–∞–ø—É—Å–∫–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
#
run_banner() {
    local folder="${1:?}"
    local banner="${2:-$folder}"

    if [[ "$VERB_MODE" == true ]]; then
        printf "\n\n\n\n"
        echo "$banner"
        command -v figlet &>/dev/null && figlet -k "$banner" -f big
    fi

    run_one_dir "$folder"
}



#
#  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä—ã folder + banner –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
#
parse_sync_list() {
    local file="$1"
    [[ -f "$file" ]] || {
        echo "–§–∞–π–ª $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
        return 1
    }

    while IFS= read -r line_raw || [[ -n "$line_raw" ]]; do
        [[ -z "$line_raw" || "$line_raw" =~ ^[[:space:]]*# ]] && continue

        eval "set -- $line_raw"  # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–≤—ã—á–∫–∏
        echo "$1|${2:-$1}"
    done < "$file"
}



#
#  –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞ –∏ —Ç–∞–π–º–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
#
#     üìå –°–ø–æ—Å–æ–±—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞:
#     Escape-–∫–æ–¥	–û–ø–∏—Å–∞–Ω–∏–µ
#     \033[A	–≤–≤–µ—Ä—Ö –Ω–∞ 1 —Å—Ç—Ä–æ–∫—É
#     \033[B	–≤–Ω–∏–∑ –Ω–∞ 1 —Å—Ç—Ä–æ–∫—É
#     \033[C	–≤–ø—Ä–∞–≤–æ –Ω–∞ 1 —Å–∏–º–≤–æ–ª
#     \033[D	–≤–ª–µ–≤–æ –Ω–∞ 1 —Å–∏–º–≤–æ–ª
#     \033[F	–≤ –Ω–∞—á–∞–ª–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç \033[A\r)
#
wait_end() {
    local seconds="${1:-${WAIT_END}}"
    local first=true
    while (( seconds >= 0 )); do
        if ! $first; then
            printf "\033[F\033[F\033[F\033[F\033[F\033[F"
        else
            first=false
        fi
        echo    "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo    "‚ïë                                                                               ‚ïë"
        echo    "‚ïë                     –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –û–∫–Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å.                        ‚ïë"
        printf  "‚ïë                     –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ [\e[0;31m%2d\e[0m] —Å–µ–∫.                   ‚ïë\n" "${seconds}"
        echo    "‚ïë                                                                               ‚ïë"
        echo    "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        # printf "\r–û–∫–Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ %2d —Å–µ–∫..." "$seconds"
        sleep 1
        ((seconds--))
    done
}



#
#
#
# =================================== MAIN ====================================
#
#
#



read_config_file



# #   DEBUG
# {
#     echo "=== –ö—Ä–æ–Ω –∑–∞–ø—É—Å–∫: $(date) ==="
#     echo "UID: $(id -u), USER: ${USER:?}, HOME: ${HOME:?}"
#     echo "PATH: ${PATH:?}"
#     echo "PWD: $(pwd)"
#     echo "SYNC_ALL_LIST_FILE: ${SYNC_ALL_LIST_FILE:?}"
#     # echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ sync_all.list:"
#     # cat "$SYNC_ALL_LIST_FILE"
# } >> ${HOME:?}/sync_all_debug.log 2>&1



case "${1:-}" in
  -h|--help)
    print_help
    exit 0
    ;;
  -u|--usage)
    print_usage
    exit 0
    ;;
  -v|--version)
    print_version
    exit 0
    ;;
  --edit-conf)
    echo "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞: ${CONFIG_FILE}"
    exec "${EDITOR}" "${CONFIG_FILE}"
    exit 0
    ;;
  --edit-list)
    echo "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞: ${SYNC_ALL_LIST_FILE}"
    exec "${EDITOR}" "${SYNC_ALL_LIST_FILE}"
    exit 0
    ;;
esac



#
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–º–∞–Ω–¥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ—ã–± –≤—Å–µ–º –ø–∞–ø–∫–∞–º –ø–µ—Ä–µ–¥–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É–± –∫–æ–º–∞–Ω–¥—É
# –Ω–∞–ø—Ä–∏–º–µ—Ä:
# sync_all.sh UP_INIT -- –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ 
#                        –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—É–∏–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö
# –†–ò–°–ö: –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–¥–∞–ª–∏—Ç —Ñ–∞–π–ª—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é–±—Ç–µ—Ä–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç —ç—Ç—É –∫–æ–º–º–∞–Ω–¥—É, 
#       —Ç–æ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—Ç—å—Å—è –Ω–∞ –≤—Å–µ—Ö –∫–ª–∏–Ω—Ç—Å–∫–∏—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. 
#       –•–æ—Ç—è, —Ç–∞–∫-–∂–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
# 
USER_CMD="${1:-}"



# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏–¥–µ—Ç—å –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª
cd "${CONFIG_PATH}" || { 
    exit_with_msg "–ü–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å–∫—Ä–∏–ø–ª–∞ [${CONFIG_PATH}] –Ω–µ —É–¥–∞–ª—Å—è." 1;
} 



case "$USER_CMD" in
    "$SHOW_LOG") print_log "${2:-}"; exit 0 ;;

    #  –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ dest-—Å—Ç—Ä–æ–∫–∏, —Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "—Ç–∏—Ö–∏–π" —Ä–µ–∂–∏–º
    "${SHOW_DEST}"|"${SHOW_CLOUD_CMD}"|"${SHOW_TEST}") VERB_MODE=false ;;

    ""|\
    "$SYNC_CMD_REGULAR"|"$SYNC_CMD_UP"|"$SYNC_CMD_DL"|\
    "$SYNC_CMD_UP_INIT"|"$SYNC_CMD_DL_INIT"|\
    "$SYNC_CMD_PAUSE"|"$SYNC_CMD_UP_EDIT"|"$SYNC_CMD_UNPAUSE") : ;;  # –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã

    *)
        exit_with_msg "–ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: [$USER_CMD]" 2;
        ;;
esac



log_info "BEG: $(date)"
log_info "VER: $VERSION"
# ${*@Q} ‚Äî —Ü–∏—Ç–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –∫–∞–∫ Bash-–ª–∏—Ç–µ—Ä–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, --opt="some val" ‚Üí '--opt=some val'), –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ª–æ–≥–æ–≤.
log_info "CMD: $0 ${*@Q}"
[[ "$VERB_MODE" == true ]] && echo "$APP_NAME VERSION $VERSION"


# ========== –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò –§–ê–ô–õ–û–í ==========



[[ -f "$SYNC_ALL_LIST_FILE" ]] || {
    exit_with_msg "–§–∞–π–ª $SYNC_ALL_LIST_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω" 1;
}


##  =================================================  ##
##                                                     ##
##  –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, —Ç—É—Ç –ø–µ—Ä–µ–±–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã—Ö –ø–∞–ø–æ–∫     ##
##                                                     ##

while IFS="|" read -r folder banner; do
    if ! run_banner "$folder" "$banner"; then
        err="–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–ø–∫–∏: $folder"
        echo     "$err" >&2
        log_info "ERR: $err"
    fi
done < <(parse_sync_list "$SYNC_ALL_LIST_FILE")

##                                                     ##
##  –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏                         ##
##                                                     ##
##  =================================================  ##



log_info "END: $(date)"
${VERB_MODE} && wait_end "${WAIT_END}"
